import React, { useEffect, useMemo, useState } from "react";
import { motion, AnimatePresence } from "framer-motion";
import { initializeApp } from "firebase/app";
import { getFirestore, collection, addDoc, serverTimestamp } from "firebase/firestore";

const DEFAULT_STATS = { K:40, S:40, R:40, T:40 };
const MAX_STEPS = 8;

// --- Firebase: ì„¤ì •(í”„ë¡œì íŠ¸ì—ì„œ ê°’ìœ¼ë¡œ ëŒ€ì²´) ---
const FIREBASE_CONFIG = null; // ì˜ˆ: { apiKey: "...", authDomain: "...", projectId: "...", ... }

let db = null;
if (FIREBASE_CONFIG) {
  try {
    const app = initializeApp(FIREBASE_CONFIG);
    db = getFirestore(app);
  } catch(e){ console.warn('firebase init fail', e); }
}

// ê°„ë‹¨í•œ clamp
const clamp = (v) => Math.max(0, Math.min(100, v));

function StatBar({label, value, emoji, colorClass}){
  return (
    <div className="bg-white/70 rounded-2xl p-3 shadow">
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-2 text-sm"><span>{emoji}</span><span>{label}</span></div>
        <div className="text-xs text-gray-400">{value}</div>
      </div>
      <div className="w-full h-2 bg-gray-200 rounded-full overflow-hidden mt-2">
        <div className={`h-full ${colorClass}`} style={{width:`${value}%`}} />
      </div>
    </div>
  );
}

export default function App(){
  const [stats, setStats] = useState(DEFAULT_STATS);
  const [step, setStep] = useState(0);
  const [cards, setCards] = useState([]);
  const [endings, setEndings] = useState([]);
  const [history, setHistory] = useState([]);
  const [dreamName, setDreamName] = useState('');
  const [dreamText, setDreamText] = useState('');

  useEffect(()=> {
    (async ()=> {
      try {
        const cRes = await fetch('/cards.json'); const cJson = await cRes.json();
        setCards(cJson);
      } catch(e){ console.warn('cards fetch fail', e); }
      try {
        const eRes = await fetch('/endings.json'); const eJson = await eRes.json();
        setEndings(eJson);
      } catch(e){ console.warn('endings fetch fail', e); }
    })();
  }, []);

  const currentCard = useMemo(()=> cards.length ? cards[step % cards.length] : null, [cards, step]);

  const applyChoice = async (choice) => {
    setStats(prev => {
      const next = {...prev};
      Object.entries(choice.delta || {}).forEach(([k,v]) => next[k] = clamp((next[k]||0)+v));
      return next;
    });
    setHistory(h => [`${currentCard.title} â†’ ${choice.label}`, ...h]);
    setStep(s => s + 1);
  };

  const reset = () => { setStats(DEFAULT_STATS); setStep(0); setHistory([]); };

  const finished = step >= MAX_STEPS;

  const evaluateEnding = () => {
    const s = stats;
    const maxVal = Math.max(s.K, s.S, s.R, s.T);
    const preferred = (s.K === maxVal ? 'K' : s.S === maxVal ? 'S' : s.R === maxVal ? 'R' : 'T');
    let candidates = endings.filter(e => (e.preferred === 'ANY' || e.preferred === preferred) && (e.threshold <= maxVal));
    if(candidates.length === 0) {
      candidates = endings.filter(e => (e.preferred === 'ANY' || e.preferred === preferred));
    }
    candidates.sort((a,b)=> (b.threshold||0) - (a.threshold||0));
    return candidates.length ? candidates[0] : {title:'ë¯¸ì •', desc:'ë‹¤ì–‘í•œ ê°€ëŠ¥ì„± ì¡´ì¬'};
  };

  const saveRecord = async () => {
    // local
    const arr = JSON.parse(localStorage.getItem('lifeGameRecords')||'[]');
    arr.push({ date: new Date().toISOString(), stats, history });
    localStorage.setItem('lifeGameRecords', JSON.stringify(arr));
    // firestore
    if(db){
      try {
        const col = collection(db, 'lifeGameRecords');
        await addDoc(col, { stats, history, createdAt: serverTimestamp() });
        alert('ì„œë²„ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
      } catch(e){ console.warn('save fail', e); alert('ì„œë²„ ì €ì¥ ì‹¤íŒ¨(ì½˜ì†” í™•ì¸)'); }
    } else {
      alert('ë¡œì»¬ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤ (Firebase ë¯¸ì„¤ì •)');
    }
  };

  const saveDream = async () => {
    if(!dreamText.trim()) return alert('ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”');
    const rec = {name: dreamName||'ìµëª…', text: dreamText, date: new Date().toISOString()};
    const arr = JSON.parse(localStorage.getItem('lifeGameDreams')||'[]'); arr.push(rec); localStorage.setItem('lifeGameDreams', JSON.stringify(arr));
    if(db){
      try {
        await addDoc(collection(db,'lifeGameDreams'), { name: rec.name, text: rec.text, createdAt: serverTimestamp() });
        alert('ë°œí‘œê°€ ì„œë²„ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
      } catch(e){ console.warn('dream save fail', e); alert('ì„œë²„ ì €ì¥ ì‹¤íŒ¨'); }
    } else {
      alert('ë¡œì»¬ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤ (Firebase ë¯¸ì„¤ì •)');
    }
    setDreamName(''); setDreamText('');
  };

  const ending = evaluateEnding();

  return (
    <div className="min-h-screen bg-gradient-to-br from-fuchsia-50 to-sky-50 p-6">
      <div className="max-w-5xl mx-auto">
        <header className="flex items-start justify-between mb-4">
          <div>
            <h1 className="text-2xl">ğŸƒ ì¸ìƒ ì—­ì „! ë¼ì´í”„ ì¹´ë“œ ê²Œì„</h1>
            <p className="text-gray-500 text-sm">ì¹´ë“œë¥¼ ê³¨ë¼ ëŠ¥ë ¥ì¹˜ë¥¼ í‚¤ì›Œ ë‹¤ì–‘í•œ ì—”ë”©ì„ ë§Œë‚˜ë³´ì„¸ìš”.</p>
          </div>
          <div className="flex gap-2">
            <button onClick={()=> setStep(s=>s+1)} className="px-3 py-2 rounded-2xl bg-indigo-500 text-white shadow">ë‹¤ìŒ ì¹´ë“œ</button>
            <button onClick={reset} className="px-3 py-2 rounded-2xl bg-gray-200">ì²˜ìŒë¶€í„°</button>
          </div>
        </header>

        <section className="grid md:grid-cols-3 gap-4">
          <div className="md:col-span-2 space-y-3">
            <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
              <StatBar label="ì§€ì‹" value={stats.K} emoji="ğŸ“˜" colorClass="bg-blue-300" />
              <StatBar label="ì²´ë ¥" value={stats.S} emoji="ğŸ’ª" colorClass="bg-green-300" />
              <StatBar label="ì¸ê°„ê´€ê³„" value={stats.R} emoji="ğŸ¤" colorClass="bg-rose-300" />
              <StatBar label="ì¬ëŠ¥" value={stats.T} emoji="âœ¨" colorClass="bg-pink-300" />
            </div>

            <AnimatePresence mode="wait">
              {!finished ? (
                <motion.div key={step} initial={{opacity:0,y:8}} animate={{opacity:1,y:0}} exit={{opacity:0,y:-8}} className="bg-white rounded-2xl p-5 shadow">
                  {currentCard ? (
                    <>
                      <h3 className="text-xl mb-1">{currentCard.title}</h3>
                      <p className="text-gray-500 mb-3">{currentCard.text}</p>
                      <div className="grid gap-2">
                        {currentCard.choices.map((c,i)=>(
                          <button key={i} onClick={()=> applyChoice(c)} className="text-left px-4 py-3 rounded-xl bg-gray-100 hover:shadow">{c.label}</button>
                        ))}
                      </div>
                    </>
                  ) : <div>ì¹´ë“œ ë¡œë”© ì¤‘...</div>}
                </motion.div>
              ) : (
                <motion.div key="end" initial={{opacity:0,y:8}} animate={{opacity:1,y:0}} className="space-y-3">
                  <div className="bg-white rounded-2xl p-5 shadow">
                    <div className="text-xl">{ending.title}</div>
                    <div className="mt-2 text-gray-600">{ending.desc}</div>
                    <div className="mt-3 flex gap-2">
                      <button onClick={saveRecord} className="px-3 py-2 rounded-2xl bg-indigo-500 text-white">ê¸°ë¡ ì €ì¥</button>
                      <button onClick={()=> {
                        const blob = new Blob([JSON.stringify({stats, history},null,2)], {type:'application/json'});
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a'); a.href=url; a.download='life-result.json'; a.click(); URL.revokeObjectURL(url);
                      }} className="px-3 py-2 rounded-2xl bg-gray-200">ê²°ê³¼ ë‚´ë³´ë‚´ê¸°</button>
                    </div>
                  </div>
                </motion.div>
              )}
            </AnimatePresence>
          </div>

          <div className="space-y-3">
            <div className="bg-white rounded-2xl p-4 shadow">
              <div className="font-semibold mb-2">ğŸ“ ì„ íƒ ê¸°ë¡</div>
              <div className="space-y-1 max-h-64 overflow-auto text-sm">{history.map((h,i)=><div key={i}>â€¢ {h}</div>)}</div>
            </div>

            <div className="bg-white rounded-2xl p-4 shadow">
              <div className="font-semibold mb-2">ğŸ† ë‚˜ì˜ ê¿ˆ ë°œí‘œ ëŒ€íšŒ</div>
              <input value={dreamName} onChange={e=>setDreamName(e.target.value)} placeholder="ì´ë¦„(ì„ íƒ)" className="w-full border rounded-xl px-3 py-2 mb-2" />
              <textarea value={dreamText} onChange={e=>setDreamText(e.target.value)} rows={3} placeholder="ë‚˜ì˜ ê¿ˆ/ì§„ë¡œ" className="w-full border rounded-xl px-3 py-2" />
              <div className="flex gap-2 mt-2">
                <button onClick={saveDream} className="px-3 py-2 rounded-2xl bg-indigo-500 text-white">ë“±ë¡</button>
              </div>
            </div>
          </div>
        </section>
      </div>
    </div>
  );
}
